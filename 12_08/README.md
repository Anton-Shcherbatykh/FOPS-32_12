
## Домашнее задание к занятию «Резервное копирование» (Щербатых А.Е.)

### Задание 1.  Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования.
Необходимо описать, какие варианты резервного копирования подходят в случаях:
1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.
1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.
1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

#### *Ответ*
1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

Ключевые требования это - "увеличить надёжность работы баз данных и их резервного копирования", плюс БД использует финансовая компания, а значит, что данные имеют высокую ценность. Из условия заадчи рискну предположить, что финансовая компания уже использует какие-то способы резервного копирования, но они по каким-то причинам не устраивают компанию. В зависимости от ТЗ и интенсивности использования БД, могут быть рассмотрены несколько способов резервного копирования:
- Полное резервное копирование (Full backup);
- Полное резервное копирование с дифференциальным бэкапом.
Интенсивность резервного копирования и дифференциального бэкапа зависит от требований и условий использования БД.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

Если данные занимают нтносительно небольшой объём и интенсивность их использования низкая, то полное резервное копирование каждый день с дифференциальным бэкапом каждый час. Этот вариант надежнее, но использует больше места для хранения.
Если данных много и интенсивность использования высокая, то полное резервное копирование каждый день с инкрементным бэкапом каждый час. Этот вариант менее надежный, но использует меньше места для хранения.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

Да, возможен. Репликация. В случае поломки БД и краха Master-сервера можно назначить «новый Master-сервер» на один из Slave-серверов и перенаправить поток запросов на него. После устранения неисправностей делается обратное переназначение и перенаправление.

### Задание 2. PostgreSQL
2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).
2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*
#### *Ответ*

2.1 Команда резервирования данных:

```bash
pg_dump sakila > sakiladb.sql
```
Если нужен другой формат, то указываем параметр -Fc:

```bash
pg_dump -Fc sakila > sakiladb.dump
```
Если БД принадлежит другому пользователю, то указываем параметр -U username:

```bash
pg_dump -U username sakila > sakiladb.sql
```

[Ссылка на документацию PostgreSQL, pg_dump](https://www.postgresql.org/docs/current/app-pgdump.html)

Команда восстановления БД:

```bash
pg_restore -d sakila sakiladb.sql
```
[Ссылка на документацию PostgreSQL, pg_restore](https://www.postgresql.org/docs/current/app-pgrestore.html)


2.1.* 





```bash
SELECT CONCAT(s.first_name , " ", s.last_name) AS 'Сотрудник магазина', cm.city AS 'Город нахождения магазина', COUNT(c.customer_id) AS 'Количество покупателей'
FROM staff AS s
JOIN address AS a ON a.address_id = s.address_id
JOIN city AS cm ON cm.city_id = a.city_id
JOIN store AS st ON st.store_id = s.store_id
JOIN customer AS c ON c.store_id = s.store_id
GROUP BY staff_id
HAVING COUNT(c.customer_id) > 300;
```
